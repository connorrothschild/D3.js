<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <style>

    @import url('https://fonts.googleapis.com/css?family=Lato');

    body { 
      margin:0;
      position:fixed;
      top:0;
      right:0;
      bottom:0;
      left:0;
      font-family: 'Lato', sans-serif;
    }
    
    .button {
      margin-top: 10px;
      min-width: 130px;
      padding: 5px 5px;
      cursor: pointer;
      text-align: center;
      font-size: 13px;
      border: 1px solid #e0e0e0;
      text-decoration: none;
    }

    .button.active {
      background: #000;
      color: #fff;
    }

    .dropdown {
      text-align-last:left;
      font-size: 36px;
      color: black;
      border: black;
      fill: grey;
    }

    text {
    	font-size: 20px;
    }

    svg {
    	margin-top:150px;
    }

    a {
    	color:#0000EE
    }

    h1 { font-size: 36px; margin: 10px 0; font-weight: normal;}
    h2 { font-size: 24px; margin: 10px 0; font-weight: normal;}
    h3 { font-size: 18px; margin: 5px 0 ; font-weight: normal;}
    header {padding: 20px; position: absolute; top: 0; left: 0;}
  
  </style>

</head>

<body>

    <header>
      <h1>Police Shootings in 
      	<input list="cityState" id="locSelector" name="locSelector" class = "dropdown" value = "Springfield, MO"/>
		<datalist id="cityState">
		<!-- options are defined here, and they are defined in a function below
			<option value="Springfield, MO"> -->
		</datalist>
		<!-- <input list="cities" id="citySelector" name="citySelector" class = "dropdown"/>
		<datalist id="cities">
		  <option value="Springfield">
		</datalist>
		<input list="states" id="stateSelector" name="stateSelector" class = "dropdown"/>
		<datalist id="states">
		  <option value="MO"> -->
		</datalist>
      <h2>Since 2013, Springfield, MO police have killed 9 people.</h2>
      <h3>Click for more information on a shooting.</h3>

    <div id="toolbar">
      <button id="all" class="button active">All</button>
      <button id="Race" class="button">By Race</button>
      <!-- <button id="Age" class="button">By Age</button> -->
      <button id="Sex" class="button">By Sex</button>
      <button id="Armed Status" class="button">By Armed Status</button>
    </div>

    </header>

  <script>
  	// ht https://bl.ocks.org/SpaceActuary/d6b5ca8e5fb17842d652d0de21e88a05
  	// ht http://bl.ocks.org/eesur/be2abfb3155a38be4de4

// create the option inputs for the datalist above. this relies on a clean list of (non-duplicated) city names.
 d3.csv('city_data.csv')
  .row(function(d){return d.CityState})
  .get(function (error, rows) {
    // The response from the server has arrived (maybe check for errors too?).
    // Let's create an empty selection of options inside a datalist:
   d3.select('datalist').selectAll('option')
      .data(function (d) {return rows})// performing a data join
      .enter() // extracting the entering selection
      .append('option') // adding an option to the selection of options
      .attr('value', function(d){return d;})
  }); 

    console.clear()
    var w = 960, h = 500;
    
    // to do: scale radius according to # of bubbles. see data.length
    var radius = 15;
    var color = d3.scaleOrdinal(d3.schemeCategory20)
    			  //.domain(["Black", "White", "Asian", "Hispanic", "Unknown race", "Pacific Islander", "Native American"])
    			  //.range("nvm");
    var centerScale = d3.scalePoint().padding(1).range([0, w]);
    var forceStrength = 0.15;

    var svg = d3.select("body").append("svg")
      .attr("width", w)
      .attr("height", h)

    var csv; 
    var selected_loc = "Springfield, MO";

    // 	data is from https://mappingpoliceviolence.org/
    // add this to footnote probably https://mappingpoliceviolence.org/aboutthedata
    d3.csv("cleaned_data.csv", function(data){
      
      data.forEach(function(d){
      	d.Age = +d.Age;
        d.r = radius;
        d.x = w / 2;
        d.y = h / 2;
      })

    csv = data;

    data = data.filter(function(d){
      // if(selected_loc=="") {
      //   return d.CityState == "Miami, FL"
      //   } else {
        return d.CityState == selected_loc
        });
      // });

    // number of rows. this is for responsive header text defined later
    length = data.length

    console.table(data); 

    var simulation = d3.forceSimulation(data)
            .force("collide",d3.forceCollide( function(d){
              	return d.r + 8 }).iterations(16) 
            )
            .force("charge", d3.forceManyBody())
            .force("y", d3.forceY().y(h / 2))
            .force("x", d3.forceX().x(w / 2))
            .on("tick", ticked);

    var body = d3.select("body");
           
    var defs = svg.append("defs");

    var patterns = defs.selectAll('circle')
      	.data(data)
      	.enter().append("pattern")
      	.attr('id', function(d) {return d.ID;})
      	.attr("width", "100%")
  	    .attr("height", "100%")
  	    .attr("patternContentUnits", "objectBoundingBox")

    var images = patterns
  	    .append("svg:image")
  	    .attr("xlink:href", function(d) { 
  	     if(d.Image !== '') { 
  	    		return d.Image
  	     } else {
  	    	return "default.jpg"
        		}
    		})
    		// if image is undefined, return default
    		// https://stackoverflow.com/questions/39988146/how-to-catch-svg-image-fail-to-load-in-d3
    		.on("error", function(d){
    			this.setAttribute("href", "default.jpg")
    		})
  	    .attr("width", 1)
  	    .attr("height", 1);

      var circles = svg.selectAll("circle")
      	.data(data)
      	.enter().append("svg:circle")
      	.attr("class", "circle")
      	.attr("r", function(d, i){ return d.r; })
        .attr("cx", function(d, i){ return 175 + 25 * i + 2 * i ** 2; })
		    .attr("cy", function(d, i){ return 250; })
    // append images to circles. see https://www.youtube.com/watch?v=FUJjNG4zkWY&t=261s
      	.attr("fill", function(d) { 
      		return "url(#" + d.ID + ")"
      })
      	.style("stroke", function(d, i){ return color(d.Race); })
      	// alt: return color(d.ID);})
      	.style("stroke-width", 2)
      	.style("pointer-events", "all")
      	.call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));

  // make the image grow a little on mouse over and add the text details on click
  var setEvents = circles
          // change top level text on click
          .on('click', function (d) {
              d3.select("h2").html(function() {
                // introducing a function for conditional formatting of h2
                // https://stackoverflow.com/questions/34454246/d3-js-conditional-tooltip-html
                if(d.Name == "Name withheld by police") {
                  return "Since 2013, " + selected_loc + " police have killed " + length + " people."
                    + "<br>"
                    + "<b>"
                    + "This victim's name was withheld by police."
                  } else {
                return "Since 2013, " + selected_loc + " police have killed " + length + " people."
                + "<br>"
                + "<b>" + d.Name + "</b> was one of them."
              }
            })
              d3.select("h3").html(function() {
                // same as above
                if(d.Name == "Name withheld by police") {
                  return "Take me to a " + "<a href='" + d.Link + "', target = '_blank'>"  + "news article describing the death of this victim⇢</a>"
                } else {
                  return "Take me to a " + "<a href='" + d.Link + "', target = '_blank'>"  + "news article describing the death of " + d.Name + " ⇢</a>"
                }
              }); 
           })

          .on('mouseenter', function() {
            // select element in current context
            d3.select(this)
              .transition()
              .attr("r", function(d, i){ return d.r*3; })
          })
          // set back
          .on('mouseleave', function() {
            d3.select(this)
              .transition()
              .attr("r", function(d, i){ return d.r; })

          });
      
      function ticked() {
        // console.log("tick")
        // console.log(data.map(function(d){ return d.x; }));
        circles
            .attr("cx", function(d){ return d.x; })
            .attr("cy", function(d){ return d.y; });
      }   
      
      function dragstarted(d,i) {
        //console.log("dragstarted " + i)
        if (!d3.event.active) simulation.alpha(1).restart();
        d.fx = d.x;
        d.fy = d.y;
      }

      function dragged(d,i) {
        //console.log("dragged " + i)
        d.fx = d3.event.x;
        d.fy = d3.event.y;
      }

      function dragended(d,i) {
        //console.log("dragended " + i)
        if (!d3.event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
        var me = d3.select(this)
        console.log(me.classed("selected"))
       me.classed("selected", !me.classed("selected"))
        
       // MODIFY ALL CIRCLES UPON CLICK 
       d3.selectAll("circle")
         .style("stroke-width", "2")
      
      // MODIFY SELECTED CIRCLE UPON CLICK
       d3.selectAll("circle.selected")
         .style("stroke-width", "5")
      	
      } 
      
      function groupBubbles() {
        hideTitles();

        // @v4 Reset the 'x' force to draw the bubbles to the center.
        simulation.force('x', d3.forceX().strength(forceStrength).x(w / 2));

        // @v4 We can reset the alpha value and restart the simulation
        simulation.alpha(1).restart();
      }
      
      function splitBubbles(byVar) {
        
        centerScale.domain(data.map(function(d){ return d[byVar]; }));
        
        if(byVar == "all"){
          hideTitles()
        } else {
	        showTitles(byVar, centerScale);
        }
        
        // @v4 Reset the 'x' force to draw the bubbles to their centers
        simulation.force('x', d3.forceX().strength(forceStrength).x(function(d){ 
        	return centerScale(d[byVar]);
        }));

        // @v4 We can reset the alpha value and restart the simulation
        simulation.alpha(2).restart();
      }
      
      function hideTitles() {
        svg.selectAll('.title').remove();
      }

      function showTitles(byVar, scale) {

       	var titles = svg.selectAll('.title')
          .data(scale.domain());
        
        titles.enter().append('text')
          	.attr('class', 'title')
        	.merge(titles)
            .attr('x', function (d) {
            	return scale(d); })
            .attr('y', 450)
            // above circles: .attr('y', 50)
            .attr('text-anchor', 'middle')
            .text(function (d) { return d });
              //+ " (" + d.length + ")"});
        
        titles.exit().remove() 
      }

      function setupButtons() {
        d3.selectAll('.button')
          .on('click', function () {
          	
            // Remove active class from all buttons
            d3.selectAll('.button').classed('active', false);
            // Find the button just clicked
            var button = d3.select(this);

            // Set it as the active button
            button.classed('active', true);

            // Get the id of the button
            var buttonId = button.attr('id');

	          console.log(buttonId)
            // Toggle the bubble chart based on
            // the currently clicked button.
            splitBubbles(buttonId);
          });
      }
      
      setupButtons()
     
d3.select("#locSelector").on("change", function() {
      
      var selected_loc = this.value;
      applyFilter(selected_loc);

    	}
    );

//  // call this whenever the filter changes
  function applyFilter(selected_loc) {

    selected_loc = selected_loc;
    console.log(selected_loc)

    // filter the data
    data = csv.filter(function(d){return d.CityState === selected_loc}); 
    console.table(data)

    length = data.length

    d3.select("h2").html("Since 2013, " + selected_loc + " police have killed " + length + " people.")

    var simulation = d3.forceSimulation(data)
            .force("collide",d3.forceCollide( function(d){
                return d.r + 8 }).iterations(16) 
            )
            .force("charge", d3.forceManyBody())
            .force("y", d3.forceY().y(h / 2))
            .force("x", d3.forceX().x(w / 2))
            .on("tick", ticked);

    var body = d3.select("body");
           
    var defs = svg.append("defs");

    var patterns = defs.selectAll('circle')
        .data(data)
        .enter().append("pattern")
        .attr('id', function(d) {return d.ID;})
        .attr("width", "100%")
        .attr("height", "100%")
        .attr("patternContentUnits", "objectBoundingBox")

    var images = patterns
        .append("svg:image")
        .attr("xlink:href", function(d) { 
         if(d.Image !== '') { 
            return d.Image
         } else {
          return "default.jpg"
            }
        })
        // if image is undefined, return default
        // https://stackoverflow.com/questions/39988146/how-to-catch-svg-image-fail-to-load-in-d3
        .on("error", function(d){
          this.setAttribute("href", "default.jpg")
        })
        .attr("width", 1)
        .attr("height", 1);

      var circles = svg.selectAll("circle")
        .data(data)
        .enter().append("svg:circle")
        .attr("class", "circle")
        .attr("r", function(d, i){ return d.r; })
        .attr("cx", function(d, i){ return 175 + 25 * i + 2 * i ** 2; })
        .attr("cy", function(d, i){ return 250; })
    // append images to circles. see https://www.youtube.com/watch?v=FUJjNG4zkWY&t=261s
        .attr("fill", function(d) { 
          return "url(#" + d.ID + ")"
      })
        .style("stroke", function(d, i){ return color(d.Race); })
        // alt: return color(d.ID);})
        .style("stroke-width", 2)
        .style("pointer-events", "all")
        .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));

  // make the image grow a little on mouse over and add the text details on click
  var setEvents = circles
          // change top level text on click
          .on('click', function (d) {
              d3.select("h2").html(function() {
                // introducing a function for conditional formatting of h2
                // https://stackoverflow.com/questions/34454246/d3-js-conditional-tooltip-html
                if(d.Name == "Name withheld by police") {
                  return "Since 2013, " + selected_loc + " police have killed " + length + " people."
                    + "<br>"
                    + "<b>"
                    + "This victim's name was withheld by police."
                  } else {
                return "Since 2013, " + selected_loc + " police have killed " + length + " people."
                + "<br>"
                + "<b>" + d.Name + "</b> was one of them."
              }
            })
              d3.select("h3").html(function() {
                // same as above
                if(d.Name == "Name withheld by police") {
                  return "Take me to a " + "<a href='" + d.Link + "', target = '_blank'>"  + "news article describing the death of this victim⇢</a>"
                } else {
                  return "Take me to a " + "<a href='" + d.Link + "', target = '_blank'>"  + "news article describing the death of " + d.Name + " ⇢</a>"
                }
              }); 
           })

          .on('mouseenter', function() {
            // select element in current context
            d3.select(this)
              .transition()
              .attr("r", function(d, i){ return d.r*3; })
          })
          // set back
          .on('mouseleave', function() {
            d3.select(this)
              .transition()
              .attr("r", function(d, i){ return d.r; })

          });
      
      function ticked() {
        // console.log("tick")
        // console.log(data.map(function(d){ return d.x; }));
        circles
            .attr("cx", function(d){ return d.x; })
            .attr("cy", function(d){ return d.y; });
      }   
      
      function dragstarted(d,i) {
        //console.log("dragstarted " + i)
        if (!d3.event.active) simulation.alpha(1).restart();
        d.fx = d.x;
        d.fy = d.y;
      }

      function dragged(d,i) {
        //console.log("dragged " + i)
        d.fx = d3.event.x;
        d.fy = d3.event.y;
      }

      function dragended(d,i) {
        //console.log("dragended " + i)
        if (!d3.event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
        var me = d3.select(this)
        console.log(me.classed("selected"))
       me.classed("selected", !me.classed("selected"))
        
       // MODIFY ALL CIRCLES UPON CLICK 
       d3.selectAll("circle")
         .style("stroke-width", "2")
      
      // MODIFY SELECTED CIRCLE UPON CLICK
       d3.selectAll("circle.selected")
         .style("stroke-width", "5")
        
      } 
      
      function groupBubbles() {
        hideTitles();

        // @v4 Reset the 'x' force to draw the bubbles to the center.
        simulation.force('x', d3.forceX().strength(forceStrength).x(w / 2));

        // @v4 We can reset the alpha value and restart the simulation
        simulation.alpha(1).restart();
      }
      
      function splitBubbles(byVar) {
        
        centerScale.domain(data.map(function(d){ return d[byVar]; }));
        
        if(byVar == "all"){
          hideTitles()
        } else {
          showTitles(byVar, centerScale);
        }
        
        // @v4 Reset the 'x' force to draw the bubbles to their centers
        simulation.force('x', d3.forceX().strength(forceStrength).x(function(d){ 
          return centerScale(d[byVar]);
        }));

        // @v4 We can reset the alpha value and restart the simulation
        simulation.alpha(2).restart();
      }
      
      function hideTitles() {
        svg.selectAll('.title').remove();
      }

      function showTitles(byVar, scale) {

        var titles = svg.selectAll('.title')
          .data(scale.domain());
        
        titles.enter().append('text')
            .attr('class', 'title')
          .merge(titles)
            .attr('x', function (d) {
              return scale(d); })
            .attr('y', 450)
            // above circles: .attr('y', 50)
            .attr('text-anchor', 'middle')
            .text(function (d) { return d });
              //+ " (" + d.length + ")"});
        
        titles.exit().remove() 
      }

      function setupButtons() {
        d3.selectAll('.button')
          .on('click', function () {
            
            // Remove active class from all buttons
            d3.selectAll('.button').classed('active', false);
            // Find the button just clicked
            var button = d3.select(this);

            // Set it as the active button
            button.classed('active', true);

            // Get the id of the button
            var buttonId = button.attr('id');

            console.log(buttonId)
            // Toggle the bubble chart based on
            // the currently clicked button.
            splitBubbles(buttonId);
          });
      }
      
      setupButtons()

     var t = d3.transition()
          .duration(750);

// this is where we style/update the new circles

var circles = d3.selectAll("circle");

    circles
      .data(data)
      .exit()
      .remove();

     circles
        .transition(t)
        .attr("fill", function(d) { 
          return "url(#" + d.ID + ")"})
         //// debug: .attr("r", function(d){ return d.r*5; })
        .style("stroke", function(d, i){ return color(d.Race); })

     circles = circles
       .enter()
       .append("circle")
       .merge(circles);

    circles
          // change top level text on click
          .on('click', function (d) {
              d3.select("h2").html(function() {
                // introducing a function for conditional formatting of h2
                // https://stackoverflow.com/questions/34454246/d3-js-conditional-tooltip-html
                if(d.Name == "Name withheld by police") {
                  return "Since 2013, " + selected_loc + " police have killed " + length + " people."
                    + "<br>"
                    + "<b>"
                    + "This victim's name was withheld by police."
                  } else {
                return "Since 2013, " + selected_loc + " police have killed " + length + " people."
                + "<br>"
                + "<b>" + d.Name + "</b> was one of them."
              }
            })
              d3.select("h3").html(function() {
                // same as above
                if(d.Name == "Name withheld by police") {
                  return "Take me to a " + "<a href='" + d.Link + "', target = '_blank'>"  + "news article describing the death of this victim⇢</a>"
                } else {
                  return "Take me to a " + "<a href='" + d.Link + "', target = '_blank'>"  + "news article describing the death of " + d.Name + " ⇢</a>"
                }
              }); 
           })
          .on('mouseenter', function() {
            // select element in current context
            d3.select(this)
              .transition()
              .attr("r", function(d, i){ return d.r*3; })
          })
          // set back
          .on('mouseleave', function() {
            d3.select(this)
              .transition()
              .attr("r", function(d, i){ return d.r; })

          });

    // setEvents
    //   .data(data).exit().remove();

    // setEvents
    //   .transition(t)

    // setEvents = setEvents
    //   .enter()
    //   .append("pattern")
    //   .merge(setEvents);

console.table(circles);

// update patterns (ids for each) 
     patterns
      .data(data).exit().remove();

     patterns
      .transition(t)
      .attr('id', function(d) {return d.ID;})

     patterns = patterns
       .enter()
       .append("pattern")
       .merge(patterns);

console.table(patterns);

// update images
    images
      .data(data).exit().remove()

    images
        .transition(t)
        .attr("xlink:href", function(d) { 
         if(d.Image !== '') { 
            return d.Image
         } else {
          return "default.jpg"
            }
        })

    images = images
       .enter()
       .append("svg:image")
       .merge(images);

console.table(images);

      // Update and restart the simulation.

// it is necessary to include the code below; otherwise clicking removes images
// https://bl.ocks.org/mbostock/1095795
  simulation.nodes(data)
            .force("collide",d3.forceCollide( function(d){
                return d.r + 8 }).iterations(16))
            .on("tick", ticked)
            .alpha(1)
            .restart();


  // DO NOT INCLUDE THE FOLLOWING CODE OR ANY VERSION OF IT!
  // simulation.force("x").initialize(data);
  // simulation.force("y").initialize(data);
  // simulation.force("charge").initialize(data)
  // simulation.force("collide").initialize(data);
 
  // simulation.force('x', d3.forceX().strength(forceStrength).x(w / 2));

	}

});
    
  </script>
</body>	